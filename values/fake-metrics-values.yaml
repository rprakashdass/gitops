# Prometheus Helm chart values
server:
  # Enable persistence with proper permissions
  persistentVolume:
    enabled: false
    size: 10Gi
    storageClass: standard
  # Security context - fsGroup makes volume writable by Prometheus user 65534
  securityContext:
    fsGroup: 65534
  containerSecurityContext:
    runAsUser: 65534
    runAsGroup: 65534
    runAsNonRoot: false

# Extra objects to deploy alongside Prometheus (log generator, promtail, metrics exporter)
extraObjects:
  # 1. Shared volume for logs
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: logs-volume
      namespace: monitoring
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
  # 2. Log Generator
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: log-generator
      namespace: monitoring
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: log-generator
      template:
        metadata:
          labels:
            app: log-generator
        spec:
          containers:
          - name: log-generator
            image: mingrammer/flog:0.4.3
            args:
            - --loop
            - --format=json
            - --number=10
            - --delay=100ms
            - --output=/var/log/generated-logs.txt
            - --overwrite
            - --type=log
            volumeMounts:
            - name: log-storage
              mountPath: /var/log
          volumes:
          - name: log-storage
            persistentVolumeClaim:
              claimName: logs-volume
  # 3. Promtail ConfigMap
  - apiVersion: v1
    kind: ConfigMap
    metadata:
      name: promtail-config
      namespace: monitoring
    data:
      config.yaml: |
        server:
          http_listen_port: 9080
          grpc_listen_port: 0
          log_level: "info"
        positions:
          filename: /tmp/positions.yaml
        clients:
          - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
            tenant_id: fake
        scrape_configs:
          - job_name: generated-logs
            static_configs:
              - targets:
                  - localhost
                labels:
                  job: generated-logs
                  __path__: /var/log/generated-logs.txt
            pipeline_stages:
              - json:
                  expressions:
                    http_method: 'method'
                    http_status: "status"
              - labels:
                  http_method:
                  http_status:
  # 4. Promtail Deployment
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: promtail
      namespace: monitoring
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: promtail
      template:
        metadata:
          labels:
            app: promtail
        spec:
          containers:
          - name: promtail
            image: grafana/promtail:3.4.3
            args:
            - -config.file=/etc/promtail/config.yaml
            volumeMounts:
            - name: log-storage
              mountPath: /var/log
            - name: promtail-config
              mountPath: /etc/promtail
          volumes:
          - name: log-storage
            persistentVolumeClaim:
              claimName: logs-volume
          - name: promtail-config
            configMap:
              name: promtail-config
  # 5. Metrics Exporter Deployment
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: metrics-exporter
      namespace: monitoring
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: metrics-exporter
      template:
        metadata:
          labels:
            app: metrics-exporter
        spec:
          containers:
          - name: metrics-exporter
            image: rslim087/metrics-exporter:latest
            ports:
            - containerPort: 8082
              name: metrics
            volumeMounts:
            - name: log-storage
              mountPath: /var/log
          volumes:
          - name: log-storage
            persistentVolumeClaim:
              claimName: logs-volume
  # 6. Metrics Exporter Service
  - apiVersion: v1
    kind: Service
    metadata:
      name: metrics-exporter
      namespace: monitoring
      labels:
        app: metrics-exporter
    spec:
      ports:
      - port: 8082
        targetPort: 8082
        name: metrics
      selector:
        app: metrics-exporter
  # 7. ServiceMonitor for Prometheus
  - apiVersion: monitoring.coreos.com/v1
    kind: ServiceMonitor
    metadata:
      name: metrics-exporter
      namespace: monitoring
      labels:
        release: prometheus
    spec:
      selector:
        matchLabels:
          app: metrics-exporter
      endpoints:
      - port: metrics
        interval: 15s